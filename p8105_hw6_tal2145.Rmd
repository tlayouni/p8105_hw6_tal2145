---
title: "Homework 6"
author: Troy Layouni
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(modelr)
```

## Problem 1
***

#### Part 1: Loading and cleaning `birthweight` dataset

* Loading csv 
* cleaning variable types 

```{r}
birthweight_df = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    mrace = as.factor(mrace), 
    mrace = recode(mrace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other", "9" = "Unknown"),
    frace = as.factor(frace), 
    frace = recode(frace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other", "9" = "Unknown"),
    malform = as.factor(malform),
    malform = recode(malform, "1" = "absent", "2" = "absent"),
    babysex = as.factor(babysex),
    babysex = recode(babysex, "1" = "male", "2" = "female")
  )
```

#### Part 2: Building a linear model

First proposed linear model: 

* this model was created through a data-driven process, adding in variables one at a time, to see whether they were significant and whether the adjusted r-squared changed by an appreciable amount to determine whether the variable should be included in my regression model. gaweeks was always included as it is a key factor in an infant's birthweight.

```{r}
birthweight_df = 
  birthweight_df %>% 
  mutate(
    mrace = fct_infreq(mrace)
  )

fit = lm(bwt ~ bhead + blength + delwt + mrace + gaweeks, data = birthweight_df)

summary(fit)
```

#### Part 3: Plotting the residuals against the fitted values

```{r}
birthweight_df %>% 
  modelr::add_residuals(fit) %>% 
  modelr::add_predictions(fit) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point() + 
  labs(
    title = "Fitted Values for Birthweight Regression Model compared to Residuals",
    x = "Predicted Values",
    y = "Model Residuals"
  )
```

#### Comparing the hypothesized model to two additional models for birthweight using cross-validation

*  using `crossv_mc` and `purr` functions to compare prediction error between the three models


##### Creating two linear models to compare to hypothesized model

```{r}
fit_2 = lm(bwt ~ gaweeks + blength, data = birthweight_df)

summary(fit_2)

fit_3 = lm(bwt ~ bhead + babysex + blength + bhead * babysex * blength, data = birthweight_df)

summary(fit_3)
```


```{r}
cv_df = 
  crossv_mc(birthweight_df, 4342)

cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))
```

```{r}
cv_df = 
  cv_df %>% 
  mutate(
    fit  = map(train, ~lm(bwt ~ bhead + blength + delwt + mrace + gaweeks, data = birthweight_df)),
         fit_2  = map(train, ~lm(bwt ~ gaweeks + blength, data = birthweight_df)),
         fit_3  = map(train, ~lm(bwt ~ bhead + babysex + blength + bhead * babysex * blength, data = birthweight_df)) 
  ) %>% 
  mutate(rmse_fit = map2_dbl(fit, test, ~rmse(model = .x, data = .y)),
         rmse_fit_2 = map2_dbl(fit_2, test, ~rmse(model = .x, data = .y)),
         rmse_fit_3 = map2_dbl(fit_3, test, ~rmse(model = .x, data = .y)))

```

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```


